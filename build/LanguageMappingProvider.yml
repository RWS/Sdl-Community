trigger: none

pool: 
  vmImage : 'windows-2022'

parameters:
- name : PublishNuget
  type: boolean
  displayName: 'Publish Nuget'
  default: false

variables:
- name: Version.MajorMinor
  value: 1.0
- name: Version.Revision
  value: $[counter(variables['Version.MajorMinor'], 0)]
- name: PipelineVersion
  value: $(Version.MajorMinor).$(Version.Revision)
- name: BuildPlatform
  value: 'Any Cpu'
- name: BuildConfiguration
  value: 'Release'
name: $(BuildDefinitionName).$(SourceBranchName)_$(Version.MajorMinor).$(Version.Revision)


steps:
- task: DotNetCoreCLI@2
  displayName: 'dotnet restore'
  inputs:
    command: 'restore'
    projects: 'LanguageMappingProvider/*.csproj'
    feedsToUse: 'select'
    vstsFeed: 'af66e256-9c46-4fba-ad75-09bf110ec1cc'
    includeNuGetOrg: false

- task: VersionDotNetCoreAssemblies@1
  displayName: 'Version .NET Core Assemblies - FileVersion'
  inputs:
    VersionRegex: '\d+\.\d+\.\d+'
    Field: FileVersion

- task: VSBuild@1
  displayName: 'Build solution LanguageMappingProvider.sln'
  inputs:
    solution: LanguageMappingProvider\LanguageMappingProvider.sln
    platform: $(BuildPlatform)
    configuration: $(BuildConfiguration)
    msbuildArchitecture: x64

- task: VersionNuspec@2
  condition: and(succeeded(), eq('${{ parameters.PublishNuget }}', 'true'))
  displayName: 'Version Nuspec'
  inputs:
    Filename: LanguageMappingProvider.nuspec
    VersionRegex: '\d+\.\d+\.\d+'

- task: DotNetCoreCLI@2
  condition: and(succeeded(), eq('${{ parameters.PublishNuget }}', 'true'))
  name: PackNuGet
  inputs:
    command: 'pack'
    packagesToPack: 'LanguageMappingProvider/LanguageMappingProvider.csproj'
    versioningScheme: 'byBuildNumber'

- task: PublishPipelineArtifact@1
  inputs:
    targetPath: '$(Build.ArtifactStagingDirectory)'
    artifact: 'Nuget'
    publishLocation: 'pipeline'